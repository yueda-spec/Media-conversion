<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±é“ç”¨ ãƒ¡ãƒ‡ã‚£ã‚¢ä¸€æ‹¬å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <style>
        body { background-color: #f0f2f5; padding-top: 2rem; font-family: "Helvetica Neue", Arial, sans-serif; }
        .main-container { max-width: 900px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .mode-card { border: 2px solid #e9ecef; padding: 15px; margin-bottom: 12px; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .mode-card:hover { background-color: #f8f9fa; border-color: #dee2e6; }
        .mode-card.selected { border-color: #0d6efd; background-color: #f0f7ff; }
        .description-box { background-color: #fff3cd; border: 1px solid #ffecb5; padding: 15px; border-radius: 8px; margin-top: 15px; display: none; color: #664d03; }
        /* çµæœãƒªã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .result-item { background: #fff; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .result-item:last-child { border-bottom: none; }
        .status-badge { font-size: 0.85rem; padding: 5px 10px; border-radius: 20px; }
        .status-waiting { background: #eee; color: #666; }
        .status-processing { background: #cfe2ff; color: #084298; animation: pulse 1.5s infinite; }
        .status-success { background: #d1e7dd; color: #0f5132; }
        .status-error { background: #f8d7da; color: #842029; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="main-container">
    <h3 class="mb-4 text-center fw-bold text-dark">ğŸ¥ å ±é“ç”¨ ãƒ¡ãƒ‡ã‚£ã‚¢ä¸€æ‹¬å¤‰æ›ãƒ„ãƒ¼ãƒ«</h3>

    <ul class="nav nav-tabs nav-fill mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button">å‹•ç”»å¤‰æ› (.mp4åŒ–)</button></li>
        <li class="nav-item"><button class="nav-link" id="photo-tab" data-bs-toggle="tab" data-bs-target="#photo-pane" type="button">å†™çœŸå¤‰æ› (HEICâ†’JPG)</button></li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="video-pane">
            <div class="mb-3">
                <label class="form-label fw-bold">1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ (è¤‡æ•°OK)</label>
                <input type="file" class="form-control" id="video-uploader" multiple>
                <div class="form-text">Ctrlã‚­ãƒ¼ã‚„Shiftã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰è¤‡æ•°é¸æŠã€ã¾ãŸã¯æ å†…ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ã§ã™ã€‚</div>
            </div>

            <label class="form-label fw-bold">2. å¤‰æ›ãƒ¢ãƒ¼ãƒ‰é¸æŠ</label>
            <div class="row">
                <div class="col-md-4">
                    <div class="mode-card" onclick="selectMode('rewrap')">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoMode" id="mode-rewrap" value="rewrap">
                            <label class="form-check-label fw-bold" for="mode-rewrap">ã‚³ãƒ³ãƒ†ãƒŠå¤‰æ›</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mode-card" onclick="selectMode('cfr')">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoMode" id="mode-cfr" value="cfr">
                            <label class="form-check-label fw-bold" for="mode-cfr">VFR â†’ CFR</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mode-card" onclick="selectMode('reencode')">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="videoMode" id="mode-reencode" value="reencode">
                            <label class="form-check-label fw-bold" for="mode-reencode">MP4å†å¤‰æ›</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="desc-rewrap" class="description-box">
                <strong>âš¡ ã‚³ãƒ³ãƒ†ãƒŠå¤‰æ› (Rewrap)</strong><br>ä¸­èº«ã¯ãã®ã¾ã¾ã§ã€Œç®±ã€ã ã‘MP4ã«å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚mkv/movç­‰ã«æœ€é©ã€‚<strong>çˆ†é€Ÿ</strong>ã§ã™ã€‚
            </div>
            <div id="desc-cfr" class="description-box">
                <strong>ğŸ”„ ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆå›ºå®š (29.97fps)</strong><br>ã‚¹ãƒãƒ›å‹•ç”»ã®éŸ³ã‚ºãƒ¬é˜²æ­¢ç”¨ã§ã™ã€‚å†åœ§ç¸®ã™ã‚‹ãŸã‚æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
            </div>
            <div id="desc-reencode" class="description-box">
                <strong>ğŸ› ï¸ MP4æ±ç”¨å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰</strong><br>ç‰¹æ®Šãªå½¢å¼ã‚’ä¸€èˆ¬çš„ãªMP4ã«ä½œã‚Šç›´ã—ã¾ã™ã€‚æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
            </div>

            <button id="video-convert-btn" class="btn btn-primary w-100 mt-4 py-2 fw-bold" disabled>
                <span id="btn-text">ã‚¨ãƒ³ã‚¸ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
            </button>
            
            <div class="card mt-4">
                <div class="card-header bg-light fw-bold">å¤‰æ›ãƒªã‚¹ãƒˆ</div>
                <div id="video-result-list" class="card-body p-0">
                    <div class="text-center text-muted p-3">ã“ã“ã«å¤‰æ›çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="photo-pane">
            <div class="alert alert-info">iPhoneã® <strong>.heic</strong> ç”»åƒã‚’ã¾ã¨ã‚ã¦ <strong>.jpg</strong> ã«å¤‰æ›ã—ã¾ã™ã€‚</div>
            <div class="mb-3">
                <input type="file" class="form-control" id="photo-uploader" accept=".heic,.HEIC" multiple>
            </div>
            <button id="photo-convert-btn" class="btn btn-success w-100 py-2 fw-bold">ä¸€æ‹¬å¤‰æ›ã‚’é–‹å§‹</button>
            
            <div class="card mt-4">
                <div class="card-header bg-light fw-bold">å¤‰æ›ãƒªã‚¹ãƒˆ</div>
                <div id="photo-result-list" class="card-body p-0">
                    <div class="text-center text-muted p-3">ã“ã“ã«å¤‰æ›çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- FFmpeg åˆæœŸåŒ– ---
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;

    const loadFFmpeg = async () => {
        const btn = document.getElementById('video-convert-btn');
        const btnText = document.getElementById('btn-text');
        
        ffmpeg = createFFmpeg({ log: false }); // ãƒ­ã‚°ãŒå¤šã„ã®ã§offæ¨å¥¨

        try {
            await ffmpeg.load();
            btnText.innerText = 'ä¸€æ‹¬å¤‰æ›ã‚’é–‹å§‹';
            btn.disabled = false;
        } catch(e) {
            console.error(e);
            btnText.innerText = 'ãƒ­ãƒ¼ãƒ‰å¤±æ•— (F12ã§ç¢ºèª)';
            alert("ã‚¨ãƒ©ãƒ¼: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
        }
    };
    loadFFmpeg();

    function selectMode(mode) {
        document.getElementById('mode-' + mode).checked = true;
        document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('selected'));
        document.getElementById('mode-' + mode).closest('.mode-card').classList.add('selected');
        document.querySelectorAll('.description-box').forEach(el => el.style.display = 'none');
        document.getElementById('desc-' + mode).style.display = 'block';
    }

    // çµæœè¡Œã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addResultRow(containerId, fileName, statusText, statusClass, rowId) {
        const container = document.getElementById(containerId);
        // åˆå›ã®ã¿ã€Œã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€ã‚’æ¶ˆã™
        if(container.querySelector('.text-muted')) container.innerHTML = '';

        const div = document.createElement('div');
        div.className = 'result-item';
        div.id = rowId;
        div.innerHTML = `
            <div class="text-truncate" style="max-width: 50%; font-weight:500;">${fileName}</div>
            <div class="d-flex align-items-center">
                <span class="status-badge ${statusClass} me-3" id="${rowId}-status">${statusText}</span>
                <span id="${rowId}-action"></span>
            </div>
        `;
        container.appendChild(div);
    }

    // çµæœè¡Œã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateResultRow(rowId, statusText, statusClass, downloadUrl = null, downloadName = null) {
        const badge = document.getElementById(`${rowId}-status`);
        const action = document.getElementById(`${rowId}-action`);
        
        badge.className = `status-badge ${statusClass} me-3`;
        badge.innerText = statusText;

        if (downloadUrl) {
            action.innerHTML = `<a href="${downloadUrl}" download="${downloadName}" class="btn btn-sm btn-primary">ä¿å­˜</a>`;
        }
    }

    // --- å‹•ç”»ä¸€æ‹¬å¤‰æ› ---
    document.getElementById('video-convert-btn').addEventListener('click', async () => {
        const fileInput = document.getElementById('video-uploader');
        const mode = document.querySelector('input[name="videoMode"]:checked');
        const btn = document.getElementById('video-convert-btn');

        if (fileInput.files.length === 0) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!mode) { alert('ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

        btn.disabled = true;
        document.getElementById('video-result-list').innerHTML = ''; // ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢

        // 1. ãƒªã‚¹ãƒˆã‚’å…ˆã«ä½œã‚‹
        const files = Array.from(fileInput.files);
        files.forEach((file, index) => {
            addResultRow('video-result-list', file.name, 'å¾…æ©Ÿä¸­...', 'status-waiting', `v-row-${index}`);
        });

        // 2. é †æ¬¡å‡¦ç†
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const rowId = `v-row-${i}`;
            const inputName = `input_${i}`;
            const outputName = `output_${i}.mp4`;

            updateResultRow(rowId, 'å¤‰æ›ä¸­...', 'status-processing');

            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿
                ffmpeg.FS('writeFile', inputName, await fetchFile(file));

                let command = [];
                if (mode.value === 'rewrap') {
                    command = ['-i', inputName, '-c', 'copy', outputName];
                } else if (mode.value === 'cfr') {
                    command = ['-i', inputName, '-r', '30000/1001', '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', outputName];
                } else if (mode.value === 'reencode') {
                    command = ['-i', inputName, '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', outputName];
                }

                await ffmpeg.run(...command);

                // èª­ã¿è¾¼ã¿ã¨URLç”Ÿæˆ
                const data = ffmpeg.FS('readFile', outputName);
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

                updateResultRow(rowId, 'å®Œäº†', 'status-success', url, `converted_${file.name}.mp4`);

                // ãƒ¡ãƒ¢ãƒªæƒé™¤ (é‡è¦: ã“ã‚Œã‚’ã‚„ã‚‰ãªã„ã¨è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹)
                try {
                    ffmpeg.FS('unlink', inputName);
                    ffmpeg.FS('unlink', outputName);
                } catch(e){}

            } catch (err) {
                console.error(err);
                updateResultRow(rowId, 'ã‚¨ãƒ©ãƒ¼', 'status-error');
            }
        }

        btn.disabled = false;
        alert("ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ");
    });

    // --- å†™çœŸä¸€æ‹¬å¤‰æ› ---
    document.getElementById('photo-convert-btn').addEventListener('click', async () => {
        const fileInput = document.getElementById('photo-uploader');
        const btn = document.getElementById('photo-convert-btn');

        if (fileInput.files.length === 0) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

        btn.disabled = true;
        document.getElementById('photo-result-list').innerHTML = ''; // ãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢

        const files = Array.from(fileInput.files);
        
        // ãƒªã‚¹ãƒˆä½œæˆ
        files.forEach((file, index) => {
            addResultRow('photo-result-list', file.name, 'å¾…æ©Ÿä¸­...', 'status-waiting', `p-row-${index}`);
        });

        // é †æ¬¡å‡¦ç†
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const rowId = `p-row-${i}`;
            
            updateResultRow(rowId, 'å¤‰æ›ä¸­...', 'status-processing');

            try {
                const resultBlob = await heic2any({ 
                    blob: file, 
                    toType: "image/jpeg", 
                    quality: 0.9 
                });
                
                // heic2anyã¯1æšã ã¨Blob, è¤‡æ•°ã ã¨Blobé…åˆ—ã‚’è¿”ã™ã“ã¨ãŒã‚ã‚‹ãŒã€
                // ã“ã“ã§ã¯ãƒ«ãƒ¼ãƒ—ã§1æšãšã¤å‡¦ç†ã—ã¦ã„ã‚‹ã®ã§BlobãŒè¿”ã‚‹ã¯ãš
                const finalBlob = Array.isArray(resultBlob) ? resultBlob[0] : resultBlob;
                const url = URL.createObjectURL(finalBlob);

                // æ‹¡å¼µå­ã‚’.jpgã«å¤‰ãˆãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½œæˆ
                const newName = file.name.replace(/\.[^/.]+$/, "") + ".jpg";

                updateResultRow(rowId, 'å®Œäº†', 'status-success', url, newName);

            } catch (e) {
                console.error(e);
                updateResultRow(rowId, 'å¤±æ•—', 'status-error');
            }
        }

        btn.disabled = false;
        alert("ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ");
    });
</script>
</body>
</html>
