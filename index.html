<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±é“ç”¨ ãƒ¡ãƒ‡ã‚£ã‚¢å¤‰æ›ãƒ„ãƒ¼ãƒ« (Stable)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <style>
        body { background-color: #f0f2f5; padding-top: 2rem; font-family: "Helvetica Neue", Arial, sans-serif; }
        .main-container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .nav-tabs .nav-link.active { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .nav-tabs .nav-link { color: #495057; font-weight: bold; }
        .mode-card { border: 2px solid #e9ecef; padding: 15px; margin-bottom: 12px; border-radius: 10px; cursor: pointer; transition: all 0.2s; position: relative; }
        .mode-card:hover { background-color: #f8f9fa; border-color: #dee2e6; }
        .mode-card.selected { border-color: #0d6efd; background-color: #f0f7ff; }
        .mode-card.selected::after { content: 'âœ“'; position: absolute; right: 15px; top: 15px; color: #0d6efd; font-weight: bold; font-size: 1.2rem; }
        .description-box { background-color: #fff3cd; border: 1px solid #ffecb5; padding: 15px; border-radius: 8px; margin-top: 20px; display: none; color: #664d03; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="main-container">
    <h3 class="mb-4 text-center fw-bold text-dark">ğŸ¥ å ±é“ç”¨ ãƒ¡ãƒ‡ã‚£ã‚¢å¤‰æ›ãƒ„ãƒ¼ãƒ«</h3>

    <ul class="nav nav-tabs nav-fill mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-pane" type="button">å‹•ç”»å¤‰æ› (.mp4åŒ–)</button></li>
        <li class="nav-item"><button class="nav-link" id="photo-tab" data-bs-toggle="tab" data-bs-target="#photo-pane" type="button">å†™çœŸå¤‰æ› (HEICâ†’JPG)</button></li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="video-pane">
            <div class="mb-3">
                <label class="form-label fw-bold">1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</label>
                <input type="file" class="form-control" id="video-uploader">
            </div>

            <label class="form-label fw-bold">2. å¤‰æ›ãƒ¢ãƒ¼ãƒ‰é¸æŠ</label>
            <div class="mode-card" onclick="selectMode('rewrap')">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="videoMode" id="mode-rewrap" value="rewrap">
                    <label class="form-check-label fw-bold" for="mode-rewrap">ã‚³ãƒ³ãƒ†ãƒŠå¤‰æ› (Rewrap)</label>
                </div>
            </div>
            <div class="mode-card" onclick="selectMode('cfr')">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="videoMode" id="mode-cfr" value="cfr">
                    <label class="form-check-label fw-bold" for="mode-cfr">VFR â†’ CFR (ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆå›ºå®š)</label>
                </div>
            </div>
            <div class="mode-card" onclick="selectMode('reencode')">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="videoMode" id="mode-reencode" value="reencode">
                    <label class="form-check-label fw-bold" for="mode-reencode">MP4å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ (æ±ç”¨)</label>
                </div>
            </div>

            <div id="desc-rewrap" class="description-box">
                <strong>âš¡ ã‚³ãƒ³ãƒ†ãƒŠå¤‰æ› (Rewrap)</strong><br>ä¸­èº«ã¯è§¦ã‚‰ãšã€Œç®±ã€ã ã‘ã‚’MP4ã«å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚Edius/Premiereã§èª­ã¿è¾¼ã‚ãªã„mkv/movãƒ•ã‚¡ã‚¤ãƒ«ç­‰ã«æœ‰åŠ¹ã€‚<br>é€Ÿåº¦ï¼š<strong>çˆ†é€Ÿ</strong> (åŠ£åŒ–ãªã—)
            </div>
            <div id="desc-cfr" class="description-box">
                <strong>ğŸ”„ VFR â†’ CFRå¤‰æ›</strong><br>ã‚¹ãƒãƒ›å‹•ç”»ãªã©ã®ã€Œå¯å¤‰ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆã€ã‚’ã€æ”¾é€ç”¨<strong>ã€Œ29.97fps (å›ºå®š)ã€</strong>ã«å¼·åˆ¶å¤‰æ›ã—ã¾ã™ã€‚éŸ³ã‚ºãƒ¬é˜²æ­¢ç”¨ã€‚<br>é€Ÿåº¦ï¼šé…ã„ (å†åœ§ç¸®)
            </div>
            <div id="desc-reencode" class="description-box">
                <strong>ğŸ› ï¸ MP4å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰</strong><br>ç‰¹æ®Šãªå½¢å¼ï¼ˆwebm, flvãªã©ï¼‰ã‚’æ±ç”¨çš„ãª H.264/AAC ã®MP4ã«ä½œã‚Šç›´ã—ã¾ã™ã€‚<br>é€Ÿåº¦ï¼šé…ã„ (å†åœ§ç¸®)
            </div>

            <button id="video-convert-btn" class="btn btn-primary w-100 mt-4 py-2 fw-bold" disabled>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                <span id="btn-text">ã‚¨ãƒ³ã‚¸ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
            </button>
            <div id="video-msg" class="mt-3 text-danger fw-bold text-center"></div>
            <div id="video-download-area" class="mt-3 text-center"></div>
        </div>

        <div class="tab-pane fade" id="photo-pane">
            <div class="alert alert-info">iPhoneã® <strong>.heic</strong> ç”»åƒã‚’ <strong>.jpg</strong> ã«å¤‰æ›ã—ã€Exifæƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</div>
            <div class="mb-3"><input type="file" class="form-control" id="photo-uploader" accept=".heic,.HEIC"></div>
            <button id="photo-convert-btn" class="btn btn-success w-100 py-2 fw-bold">JPEGã«å¤‰æ›</button>
            <div id="photo-msg" class="mt-3 fw-bold text-center"></div>
            <div id="photo-download-area" class="mt-3 text-center"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- FFmpeg v0.11.6 åˆæœŸåŒ– (GitHub Pagesã§å®‰å®šå‹•ä½œã™ã‚‹ç‰ˆ) ---
    const { createFFmpeg, fetchFile } = FFmpeg;
    let ffmpeg = null;

    const loadFFmpeg = async () => {
        const btn = document.getElementById('video-convert-btn');
        const btnText = document.getElementById('btn-text');
        
        // ãƒ­ã‚°å‡ºåŠ›ã‚’æœ‰åŠ¹åŒ–
        ffmpeg = createFFmpeg({ log: true });

        try {
            await ffmpeg.load();
            btnText.innerText = 'å‹•ç”»å¤‰æ›ã‚’é–‹å§‹';
            btn.disabled = false;
        } catch(e) {
            console.error(e);
            btnText.innerText = 'ãƒ­ãƒ¼ãƒ‰å¤±æ•— (F12ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª)';
            document.getElementById('video-msg').innerText = "ã‚¨ãƒ©ãƒ¼: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚";
        }
    };
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ãƒ¼ãƒ‰é–‹å§‹
    loadFFmpeg();

    function selectMode(mode) {
        document.getElementById('mode-' + mode).checked = true;
        document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('selected'));
        document.getElementById('mode-' + mode).closest('.mode-card').classList.add('selected');
        document.querySelectorAll('.description-box').forEach(el => el.style.display = 'none');
        document.getElementById('desc-' + mode).style.display = 'block';
    }

    document.getElementById('video-convert-btn').addEventListener('click', async () => {
        const fileInput = document.getElementById('video-uploader');
        const mode = document.querySelector('input[name="videoMode"]:checked');
        const msg = document.getElementById('video-msg');
        const dlArea = document.getElementById('video-download-area');
        const btn = document.getElementById('video-convert-btn');

        if (!fileInput.files[0]) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!mode) { alert('ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

        msg.innerText = 'å¤‰æ›ä¸­... é‡ã„å‹•ç”»ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚';
        btn.disabled = true;
        btn.querySelector('.spinner-border').classList.remove('d-none');
        dlArea.innerHTML = '';

        const file = fileInput.files[0];
        const fileName = 'input_video';

        try {
            // v0.11ç³»ã®æ›¸ãæ–¹
            ffmpeg.FS('writeFile', fileName, await fetchFile(file));
            let command = [];

            if (mode.value === 'rewrap') {
                command = ['-i', fileName, '-c', 'copy', 'output.mp4'];
            } else if (mode.value === 'cfr') {
                command = ['-i', fileName, '-r', '30000/1001', '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', 'output.mp4'];
            } else if (mode.value === 'reencode') {
                command = ['-i', fileName, '-c:v', 'libx264', '-preset', 'ultrafast', '-c:a', 'aac', 'output.mp4'];
            }

            await ffmpeg.run(...command);
            
            const data = ffmpeg.FS('readFile', 'output.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

            msg.innerText = 'å¤‰æ›å®Œäº†ï¼';
            dlArea.innerHTML = `<a href="${url}" download="converted_${mode.value}.mp4" class="btn btn-success btn-lg">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>`;
            
            // å¾Œå§‹æœ«
            try { ffmpeg.FS('unlink', fileName); ffmpeg.FS('unlink', 'output.mp4'); } catch(e){}

        } catch (err) {
            console.error(err);
            msg.innerText = 'å¤‰æ›ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
        }
        btn.disabled = false;
        btn.querySelector('.spinner-border').classList.add('d-none');
    });

    document.getElementById('photo-convert-btn').addEventListener('click', async () => {
        const fileInput = document.getElementById('photo-uploader');
        const msg = document.getElementById('photo-msg');
        const dlArea = document.getElementById('photo-download-area');
        if (!fileInput.files[0]) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        
        msg.innerText = 'å¤‰æ›ä¸­...';
        try {
            const resultBlob = await heic2any({ blob: fileInput.files[0], toType: "image/jpeg", quality: 0.9 });
            const url = URL.createObjectURL(resultBlob);
            msg.innerText = 'å¤‰æ›å®Œäº†ï¼';
            dlArea.innerHTML = `<a href="${url}" download="converted_photo.jpg" class="btn btn-primary btn-lg">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>`;
        } catch (e) {
            msg.innerText = 'ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹æœªå¯¾å¿œã§ã™ã€‚';
        }
    });
</script>
</body>
</html>
